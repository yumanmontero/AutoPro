@using AutoPro.Models
@model PreventaViewModels
@{
    ViewBag.Title = "Proceso de Preventa";

    UsuarioViewModel user = new UsuarioViewModel();
    if (HttpContext.Current.Session["User"] != null)
    {
        user = HttpContext.Current.Session["User"] as UsuarioViewModel;
    }
    else
    {

        user = HttpContext.Current.Session["User"] as UsuarioViewModel;

    }
}


    <!-- Content Header (Page header) -->
<section class="content-header">
    <h1 id="titulo_preventa">Menu de Venta
     
        <small>@user.Concesionario</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="/Home/"><i class="fa fa-dashboard"></i> Inicio</a></li>
        <li><a href="/Venta/">Venta</a></li>
        <li class="active">@ViewBag.Title</li>
    </ol>
</section>

<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-md-8">
            <div class="box">
                <div class="box-header with-border">
                    <h3 class="box-title">Linea de tiempo</h3>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                
                    <div id="time_line_cliente" class="row margin">
                        <!-- linea de tiempo -->
                        <ul class="timeline">
                            @foreach (var item in Model.Lista_Transacciones)
                            {
                               <!-- timeline time label -->
                                <li class="time-label">
                                    <span class="bg-red">
                                        @item.fecha.ToShortDateString() - @item.fecha.ToShortTimeString()
                                    </span>
                                </li>
                                     <!-- timeline item -->
                                 
                                        var class_tran = "";
                                        var titulo_op ="";
                                        if(item.Tipo_Transaccion == 1)
                                        {
                                            class_tran = "fa fa-envelope bg-blue";
                                            titulo_op = "Operación de Preventa # " + item.id;
               
                                        }else
                                        {

                                            class_tran = "fa fa-envelope bg-green"; 
                                            titulo_op = "Operación de Venta # " + item.id;
                                        }
                                       
                                <li>
                                    <i class="@class_tran"></i>

                                    <div class="timeline-item">
                                        <span class="time"><i class="fa fa-clock-o"></i> @item.Cant_Tiempo_Transcurrido</span>

                                        <h3 class="timeline-header"><a href="#">@titulo_op</a></h3>

                                        <div class="timeline-body">
                                            @if(item.Tipo_Transaccion == 1)
                                            {
                                                @:El cliente estuvo interesando en <strong>@item.Cant_Vehiculos</strong> modelos, con rangos de precios [<strong>@item.Menor_Monto.ToString("#,##0")<sup style="font-size: 8px">USD</sup> - @item.Mayor_Monto.ToString("#,##0") <sup style="font-size: 8px">USD</sup></strong>] y el agente encargado de la operacion fue <strong>@item.Nombre_Operador</strong>.
                                                
                                            }else{
                                                @:El cliente compro <strong>@item.Cant_Vehiculos</strong> vehiculos, el monto total de la operación fue de <strong>@item.Monto_Total.ToString("#,##0")<sup style="font-size: 8px">USD</sup></strong> y el agente encargado de la operacion fue <strong>@item.Nombre_Operador</strong>.
                                            }
                                        </div>
                                        <div class="timeline-footer">
                                            <a onclick="MostrarDetalles(@item.id);" class="btn btn-primary btn-xs">Detalles</a>
                                        </div>
                                    </div>
                                </li>
                                foreach (var auto in item.Lista_Vehiculo)
                                {
                                    <li>
                                        <i class="fa fa-automobile bg-yellow"></i>

                                        <div class="timeline-item">

                                            <h3 class="timeline-header"><a href="#">@auto.modelo.modelo1 @auto.modelo.nombre # @auto.id_vehiculo</a> @auto.modelo.año</h3>

                                            <div class="timeline-body">
                                                @if(item.Tipo_Transaccion == 1)
                                                {

                                                    @:El modelo es de color <strong>@auto.color</strong> tiene <strong>@auto.kilometraje.ToString("#,##0")</strong> kilometros y esta valorado en <strong>@auto.valor_compra.ToString("#,##0")</strong><sup style="font-size: 8px">USD</sup>. 
                                                }
                                                else
                                                {
                                                   @:El modelo es de color <strong>@auto.color</strong> tiene <strong>@auto.kilometraje.ToString("#,##0")</strong> kilometros y el valor de venta del modelo fue de <strong>@auto.valor_venta.Value.ToString("#,##0")</strong><sup style="font-size: 8px">USD</sup>.      
                                                }
                                                @{
                                                    var imagen = "";
                                                    if((auto.imagen != null) && (auto.imagen != ""))
                                                    {
                                                        imagen = auto.imagen;
                                                    }else
                                                    {
                                                        imagen = auto.modelo.imagen;
                                                   
                                                    }
                                                }
                                               
                                                <img style="height:100px; width:150px" src="@imagen" alt="@auto.modelo.nombre" class="margin">
                                            </div>
                                            <div class="timeline-footer">
                                                <a class="btn btn-primary btn-xs">@auto.modelo.marca.nombre</a>
                                                <a class="btn btn-success btn-xs">@auto.modelo.modelo_clasificacion.descripcion</a>
                                                <a class="btn btn-warning btn-flat btn-xs">@auto.modelo.modelo1</a>
                                                <a class="btn btn-danger btn-xs">@auto.modelo.año</a>
                                            </div>
                                        </div>
                                    </li>

                                }



                            }
                           

                            <li>
                                <i class="fa fa-clock-o bg-gray"></i>
                            </li>
                        </ul>
                        <!-- /.linea de tiempo -->


                    </div>

                </div>
                <!-- /.box-body -->

            </div>
            <!-- /.box -->
            <!-- /.box -->
        </div>
        <!-- /.col -->
        <div class="col-md-4">
            <div style="height:330px" class="box box-primary">
                <div class="box-body box-profile">
                    <img class="profile-user-img img-responsive img-circle" src="/Images/imagen_user_160.png" alt="User profile picture">

                    <h3 class="profile-username text-center">@Model.Cliente.Nombre_Completo</h3>

                    <p class="text-muted text-center">Información del cliente</p>

                    <ul class="list-group list-group-unbordered">
                        <li class="list-group-item">
                            <b>Telefono</b> <a class="pull-right">@Model.Cliente.Nro_Telefono</a>
                        </li>
                        <li class="list-group-item">
                            <b>Correo</b> <a class="pull-right">@Model.Cliente.Email</a>
                        </li>
                        <li class="list-group-item">
                            <b>Dirección</b> <a class="pull-right">@Model.Cliente.Direccion</a>
                        </li>
                    </ul>

                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box-body -->

            
        </div>
        <!-- /.box -->
    </div>
    <!-- /.col -->
    <div class="row">
       <div class="col-lg-12 col-xs-12">
           <div class="box">
               <div class="box-header">
                   <div class="form-group">


                       <div class="row">


                           <div class="col-lg-3 col-md-3 col-xs-1">

                           </div>
                           <!-- ./col -->
                           <div class="col-lg-6 col-md-6 col-xs-10">
                               <!-- small box -->
                               <!-- ESTA ES LA BARRA ARREGLADA NO SE SI LO QUE AGARRE PARA CONVERTIRLA EN INPUT ESTA BIEN REVISALO
        DE TODAS MANERAS CUANDO LO PEGUES A VER -->
                               <div class="row">
                                   <div class="col-lg-12">
                                       <div style="width:100%" class="input-group">
                                           <select style="width:100%" class="form-control select2" data-val="true" id="Busq_Modelo" name="Busq_Modelo" data-placeholder="Escriba un Modelo">
                                               <option value="-1"></option>
                                           </select>
                                           <span class="input-group-btn">
                                               <button href="javascript:{}" onclick="document.getElementById('busquedaid').submit();" class="btn btn-default"><i class="fa fa-search"></i></button>
                                           </span>
                                       </div><!-- /input-group -->
                                   </div><!-- /.col-lg-6 -->
                               </div><!-- /.row -->


                           </div>
                           <!-- ./col -->
                           <div class="col-lg-3 col-md-3 col-xs-1">

                           </div>
                           <!-- ./col -->

                       </div>





                   </div>
               </div>
               <!-- /.box-header -->
               <div id="ventana_cambio" class="box-body no-padding carga" >
                   <div style="height:500px" class="cargando"></div>

               </div>
               <!-- /.box-body -->
               <div class="box-footer no-border">
                   <div class="row">
                       <div class="col-xs-4 text-center" style="border-right: 1px solid #f4f4f4">
                           <button type="button" class="btn btn-success btn-lg"><i class="fa fa-cart-plus"></i></button>
                       </div>
                       <!-- ./col -->
                       <div class="col-xs-4 text-center" style="border-right: 1px solid #f4f4f4">
                           
                       </div>
                       <!-- ./col -->
                       <div class="col-xs-4 text-center">
                           <button type="button" class="btn btn-danger btn-lg"><i class="fa fa-rotate-left"></i></button>
                       </div>
                       <!-- ./col -->
                   </div>
                   <!-- /.row -->
               </div>
               <!-- /.box-footer -->
           </div>


       </div>


    </div>
</section>


<!-- jQuery 2.2.3 -->
<script src="~/Content/Template/plugins/jQuery/jquery-2.2.3.min.js"></script>
<script>

    jQuery(window).load(function () {

        $(document).ajaxStart(function() 
        { 
            $('#ventana_cambio').addClass("carga_proceso"); 
        });

        $(document).ajaxStop(function() 
        { 
            $('#ventana_cambio').removeClass("carga_proceso"); 
        });
        
        $('#time_line_cliente').slimScroll({
            height: '330px'
        });
        var dataurl = '@Url.Content("~/Venta/PreventaMenuInicial/?id_cliente=1")';
        $.ajax({
              url: dataurl
          }).done(function (data) {
              // Al div con id todos le pone como
              // contenido la partial view recibida (data)
              $('#ventana_cambio').html(data);
              CargarFunciones_Pref_Cliente_Merc();
          }).fail(function (jqXHR, textStatus, errorThrown) {
              alert("Error: " + jqXHR);


          });


        function formatRepo(repo) {
            if (repo.Image === undefined) return "Cargando...";

            var markup = "<div class='select2-result-repository clearfix'>" +
              "<div class='select2-result-repository__avatar'><img src='" + repo.Image + "' /></div>" +
              "<div class='select2-result-repository__meta'>" +
                "<div class='select2-result-repository__title'>" + repo.Nombre + "</div>";

            if (repo.Descripcion) {
                markup += "<div class='select2-result-repository__description'>" + repo.Descripcion + "</div>";
            }

            markup += "<div class='select2-result-repository__statistics'>" +
              "<div class='select2-result-repository__forks'><i class='fa fa-folder-open-o'></i> " + repo.Nro_Inventario + " Inventario</div>" +
              "<div class='select2-result-repository__stargazers'><i class='fa  fa-cart-plus'></i> " + repo.Nro_Vendidos + " Vendidos</div>" +
              "<div class='select2-result-repository__watchers'><i class='fa fa-area-chart'></i> " + repo.Nro_Rezagados + " Rezagados</div>" +
            "</div>" +
            "</div></div>";

            return markup;
        }

        function formatRepoSelection(repo) {
            return repo.Nombre;
        }

        $("#Busq_Modelo").select2({
            placeholder: "Consulte un modelo",
            ajax: {
                url: "/Venta/ObtenerModelos",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term, // search term
                        page: params.page
                    };
                },
                processResults: function (data, params) {
                    // parse the results into the format expected by Select2
                    // since we are using custom formatting functions we do not need to
                    // alter the remote JSON data, except to indicate that infinite
                    // scrolling can be used
                    params.page = params.page || 1;

                    return {
                        results: data.Lista_Modelo,
                        pagination: {
                            more: (params.page * 30) < data.Total_Modelos
                        }
                    };
                },
                cache: true
            },
            escapeMarkup: function (markup) { return markup; },
            minimumInputLength: 1,
            templateResult: formatRepo,
            templateSelection: formatRepoSelection


        });

    });

    function CargarFunciones_Pref_Cliente_Merc()
    {
        $('#pref_cliente_div').on('click', function () {


            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);
                CargarFunciones_Lista_Marc_Cat();
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });

        $('#pref_merc_div').on('click', function () {

            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);
                CargarFunciones_Lista_Marc_Cat();
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });

        $('#prioritario_div').on('click', function () {

            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);

            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });

        $('#inventario_div').on('click', function () {

            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });

    }

    function goBack() {
        window.history.back();
    }

    function CargarFunciones_Lista_Marc_Cat() {
        $('#marcas_div').slimScroll({
            height: '450px'
        });
        $('#cat_div').slimScroll({
            height: '450px'
        });

        $('#cat_div').on('click', 'a[data-url]', function () {

            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);
                CargarFunciones_Lista_Vehiculos();
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });

        $('#marcas_div').on('click', 'a[data-url]', function () {

            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);
                CargarFunciones_Lista_Vehiculos();
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });

    }

    function CargarFunciones_Lista_Vehiculos() {

        $('#vehiculos_div').slimScroll({
            height: '470px'
        });

        $('#vehiculos_div').on('click', 'a[data-url]', function () {

            var dataUrl = $(this).data('url');
            $.ajax({
                url: dataUrl
            }).done(function (data) {
                // Al div con id todos le pone como
                // contenido la partial view recibida (data)
                $('#ventana_cambio').html(data);
                CargarFunciones_Vehiculos_Detalles();
            }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Error: " + errorThrown);


            });
        });


    }

    function CargarFunciones_Vehiculos_Detalles() {


        $('#estadisticas_carro').slimScroll({
            height: '250px'
        });

        $("#id_Financista").select2({
            placeholder: "Seleccione un Agente"
        });

        $('#Valor_Venta').removeClass('single-line');
        $('#Valor_Venta').removeClass('text-box').addClass('form-control');
        $('#Comentario').removeClass('single-line');
        $('#Comentario').removeClass('text-box').addClass('form-control');

        $("#Valor_Venta").on('input', function () {
            var LocalidadOptions = {};
            LocalidadOptions.url = "/Venta/CalcularComision";
            LocalidadOptions.type = "POST";
            LocalidadOptions.data = JSON.stringify({ monto: document.getElementById("Valor_Venta").value , id_usuario: @user.id_Usuario });
            LocalidadOptions.datatype = "json";
            LocalidadOptions.contentType = "application/json";
            LocalidadOptions.success = function (data) {
                if (data != undefined) {

                    var minimo = parseFloat(data, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString();
                    minimo = minimo.replace(/[,.]/g, function (m) {return m === ',' ? '.' : ','; });
                    minimo += '<sup style="font-size: 20px">USD</sup>';

                    document.getElementById("comision_ganar").innerHTML = minimo;

                } else {
                    alert("Error al calcular el Monto, Intente mas Tarde " + data)
                }

            };
            LocalidadOptions.error = function () { alert("Error al calcular el Monto."); };
            $.ajax(LocalidadOptions);



        });


    }



</script>

